name: iOS Build Unsigned

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    defaults:
      run:
        working-directory: apps/native

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read server URL from config
        id: config
        run: |
          SERVER_URL=$(cat ../../server-config.json | jq -r '.serverUrl')
          echo "server_url=$SERVER_URL" >> $GITHUB_OUTPUT
          echo "Using server URL: $SERVER_URL"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          token: ${{ secrets.EXPO_TOKEN }}
          expo-version: latest

      - name: Install dependencies
        run: bun install
        working-directory: .

      - name: Remove problematic native modules for sideload test
        run: |
          cd ../..
          
          # Remove expo-dev-client
          bun remove expo-dev-client --cwd apps/native 2>/dev/null || true
          
          # Remove native modules that may crash on sideloaded apps
          # Reanimated v4 REQUIRES New Architecture, which breaks sideloading
          bun remove react-native-reanimated --cwd apps/native || true
          
          # Unistyles has native module that may not initialize properly
          bun remove react-native-unistyles --cwd apps/native || true
          
          # Reinstall to update lockfile
          bun install
          
          # IMPORTANT: Delete reanimated AFTER bun install because bun hoists it to root
          # and may reinstall it as a transitive dependency
          echo "=== Forcibly removing reanimated from all node_modules ==="
          find . -type d -name "react-native-reanimated" -exec rm -rf {} + 2>/dev/null || true
          
          # Create a stub for react-native-unistyles so imports don't break
          echo "=== Creating unistyles stub ==="
          mkdir -p node_modules/react-native-unistyles
          printf '%s\n' 'const mockTheme = { colors: { background: "#ffffff", foreground: "#000000", primary: "#007AFF", secondary: "#5856D6", muted: "#8E8E93", border: "#C6C6C8", card: "#F2F2F7", notification: "#FF3B30" }, spacing: { xs: 4, sm: 8, md: 16, lg: 24, xl: 32 } };' > node_modules/react-native-unistyles/index.js
          printf '%s\n' 'module.exports = { useUnistyles: () => ({ theme: mockTheme, styles: {} }), createStyleSheet: (fn) => typeof fn === "function" ? fn(mockTheme) : fn, UnistylesRegistry: { addBreakpoints: () => ({ addThemes: () => ({ addConfig: () => ({}) }) }), addThemes: () => ({ addConfig: () => ({}) }), addConfig: () => ({}) } };' >> node_modules/react-native-unistyles/index.js
          printf '%s\n' '{"name":"react-native-unistyles","version":"0.0.0-stub","main":"index.js"}' > node_modules/react-native-unistyles/package.json
          
          # Create a stub for react-native-reanimated (needed by drawer-layout)
          echo "=== Creating reanimated stub ==="
          mkdir -p node_modules/react-native-reanimated
          printf '%s\n' 'const noop = () => {}; const identity = (x) => x; const useSharedValue = (v) => ({ value: v }); const useAnimatedStyle = () => ({}); const withTiming = identity; const withSpring = identity; const runOnJS = (fn) => fn; const runOnUI = (fn) => fn;' > node_modules/react-native-reanimated/index.js
          printf '%s\n' 'module.exports = { default: { createAnimatedComponent: (c) => c }, useSharedValue, useAnimatedStyle, useDerivedValue: useSharedValue, useAnimatedReaction: noop, withTiming, withSpring, withDelay: identity, withSequence: identity, withRepeat: identity, runOnJS, runOnUI, Easing: { linear: identity, ease: identity, bezier: () => identity }, FadeIn: {}, FadeOut: {}, SlideInRight: {}, SlideOutRight: {}, Layout: {}, Animated: { View: require("react-native").View, Text: require("react-native").Text, ScrollView: require("react-native").ScrollView, Image: require("react-native").Image }, interpolate: (v) => v, Extrapolate: { CLAMP: "clamp" }, cancelAnimation: noop, measure: noop, scrollTo: noop, setGestureState: noop, makeMutable: useSharedValue, reduceMotion: { Never: 0 }, ReduceMotion: { Never: 0 }, configureReanimatedLogger: noop };' >> node_modules/react-native-reanimated/index.js
          printf '%s\n' '{"name":"react-native-reanimated","version":"0.0.0-stub","main":"index.js"}' > node_modules/react-native-reanimated/package.json
          
          # Verify reanimated podspec is gone (native code removed, JS stub remains)
          echo "=== Checking if reanimated podspec is still present ==="
          find . -name "RNReanimated.podspec" 2>/dev/null || echo "Reanimated podspec not found (good!)"
          
          echo "=== Remaining dependencies ==="
          cat apps/native/package.json | grep -A 50 '"dependencies"'

      - name: Prebuild iOS
        run: |
          # Clean prebuild to ensure fresh native code
          bun expo prebuild --platform ios --clean
          
          # Log the generated AppDelegate to check for issues
          echo "=== Generated AppDelegate.mm ==="
          head -100 ios/whex/AppDelegate.mm || echo "AppDelegate.mm not found"
        env:
          EXPO_PUBLIC_SERVER_URL: ${{ steps.config.outputs.server_url }}

      - name: Setup Xcode environment
        run: |
          # Create .xcode.env.local to ensure env vars are available during build
          echo "export EXPO_PUBLIC_SERVER_URL=${{ steps.config.outputs.server_url }}" > ios/.xcode.env.local
          echo "export NODE_BINARY=$(which node)" >> ios/.xcode.env.local
          cat ios/.xcode.env.local

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Build Archive (with bundling)
        run: |
          cd ios
          
          # Ensure Node is available for the Xcode build script
          export NODE_BINARY=$(which node)
          
          xcodebuild -workspace *.xcworkspace \
            -scheme whex \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/MyApp.xcarchive \
            clean archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_STYLE=Manual
        env:
          EXPO_PUBLIC_SERVER_URL: ${{ steps.config.outputs.server_url }}

      - name: Verify bundle in archive
        run: |
          echo "=== Contents of .app bundle ==="
          ls -la ios/build/MyApp.xcarchive/Products/Applications/*.app/ || echo "Could not list .app contents"
          
          echo "=== Checking for main.jsbundle ==="
          find ios/build -name "main.jsbundle" -o -name "*.jsbundle" 2>/dev/null || echo "No jsbundle found"
          
          echo "=== Checking bundle size ==="
          BUNDLE_PATH="ios/build/MyApp.xcarchive/Products/Applications/whex.app/main.jsbundle"
          ls -lh "$BUNDLE_PATH" 2>/dev/null || echo "main.jsbundle not found in .app"
          
          echo "=== Checking if bundle is Hermes bytecode ==="
          if [ -f "$BUNDLE_PATH" ]; then
            # Hermes bytecode starts with specific magic bytes (c61f bc03)
            echo "First 16 bytes (hex):"
            xxd -l 16 "$BUNDLE_PATH" | head -1
            file "$BUNDLE_PATH" || echo "file command not available"
            
            # Check bundle is not empty or corrupted
            BUNDLE_SIZE=$(stat -f%z "$BUNDLE_PATH" 2>/dev/null || stat -c%s "$BUNDLE_PATH" 2>/dev/null)
            echo "Bundle size: $BUNDLE_SIZE bytes"
            if [ "$BUNDLE_SIZE" -lt 1000 ]; then
              echo "WARNING: Bundle seems too small!"
            fi
          fi
          
          echo "=== Checking for Hermes framework ==="
          ls -la ios/build/MyApp.xcarchive/Products/Applications/*.app/Frameworks/ 2>/dev/null | grep -i hermes || echo "Hermes framework not found"
          
          echo "=== Check Info.plist for JS engine ==="
          plutil -p ios/build/MyApp.xcarchive/Products/Applications/*.app/Info.plist 2>/dev/null | grep -i "hermes\|jsc\|javascript\|RCT" || echo "No JS engine info found"
          
          echo "=== Check embedded assets ==="
          ls -la ios/build/MyApp.xcarchive/Products/Applications/*.app/assets/ 2>/dev/null | head -20 || echo "No assets folder found"

      - name: Package IPA
        run: |
          cd ios
          mkdir -p Payload
          cp -r build/MyApp.xcarchive/Products/Applications/*.app Payload/
          zip -r MyApp-Unsigned.ipa Payload

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-Unsigned.ipa
          path: apps/native/ios/MyApp-Unsigned.ipa
